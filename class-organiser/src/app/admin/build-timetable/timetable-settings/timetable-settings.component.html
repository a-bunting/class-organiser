<div class="ttsettings__chooseTimetable" *ngIf="timetableSelectionScreen">
  <div class="ttsettings__chooseTimetable--backdrop" (click)="timetableSelectionScreenToggle(false)"></div>
  <div class="ttsettings__chooseTimetable--data">

    <app-small-loader *ngIf="selectedTimetableLoading"></app-small-loader>

    <div class="ttsettings__chooseTimetable--title">
      <div class="ttsettings__chooseTimetable--text">Choose your timetable from the choices below:</div>
      <button class="input__button input__length--veryshort" (click)="timetableSelectionScreenToggle(false)">X</button>
    </div>

    <table>
      <tr>
        <th [ngStyle]="{'width': '5rem'}" [attr.colspan]="timetableSelectionData.statistics[0].stats.prioritySatisfied.length">Students who got their nth choice (%)</th>
        <th rowspan="2"># who got their 1st or 2nd choice (%)</th>
        <th rowspan="2">Missed their 1st and 2nd choice</th>
        <th rowspan="2">Students missing a block</th>
        <th rowspan="2">Students missing required</th>
        <th rowspan="2">Select</th>
      </tr>
      <tr>
        <th [ngStyle]="{'width': '5rem'}" *ngFor="let priority of timetableSelectionData.statistics[0].stats.prioritySatisfied; let i = index">{{ i + 1 | ordinal }}</th>
      </tr>
      <tr *ngFor="let data of timetableSelectionData.statistics">
        <td *ngFor="let priority of data.stats.prioritySatisfied">{{ (priority / loadedTimetable.students.length) * 100 | number:'0.0-0' }} %</td>
        <td>{{ (data.stats.priorityOneOrTwo / loadedTimetable.students.length) * 100 | number:'0.0-0' }} %</td>
        <td>{{ getStudentNamesFromArray(data.stats.nonOneOrTwo) }}</td>
        <td>{{ data.stats.unplaced }}</td>
        <td>{{ getStudentNamesFromArray(data.stats.notAllRequired) }}</td>
        <td><button class="input__button input__length--small" (click)="chooseTimetable(data.index)">Select</button></td>
      </tr>
    </table>
  </div>
</div>

<app-loading-spinner *ngIf="loading"></app-loading-spinner>

<div class="ttsettings">


  <div class="ttsettings__title">
    <p>Settings</p>
    <input type="text" class="input__text input__length--long" *ngIf="loadedTimetable" [(ngModel)]="loadedTimetable.name">
  </div>

  <!-- <div class="ttsettings__flex">

    <div class="ttsettings__flex--col">

      <div class="ttsettings__select" *ngIf="loadedTimetable">
        <div class="ttsettings__text">Rename Timetable</div>
        <div class="ttsettings__timetable">
        </div>
      </div>
    </div>
  </div> -->

  <div class="ttsettings__select ttsettings__buttons" *ngIf="loadedTimetable">
    <div class="ttsettings__text">Controls</div>

    <div class="ttsettings__buttons--row">
      <div class="ttsettings__buttons--left">
        <div class="ttsettings__buttons--button">
          <img src="../../../../assets/icons/unlocked.png" alt="Input UnLocked" [tooltip]="'Students can currently input or edit their data, click to lock this.'">
          <!-- <img src="../../../../assets/icons/lock.png" alt="Input Locked" [tooltip]="'Students cannot current add or change data. Click to unlock this.'"> -->
        </div>
        <div class="ttsettings__buttons--button" (click)="toggleDownloadMenu($event)">
          <img src="../../../../assets/icons/download.png" alt="Export Data" [tooltip]="'Export this data'">

        </div>
        <div class="menu" id="downloadMenu" *ngIf="downloadMenuOpened">
          <div class="menu__button" (click)="googleExport()">Export to Google Sheets</div>
        </div>
        <div class="ttsettings__buttons--button" (click)="print()"><img src="../../../../assets/icons/printer.png" alt="Print Timetable" [tooltip]="'Print this timetable'"></div>
      </div>
      <div class="ttsettings__buttons--right">
        <div class="ttsettings__buttons--button" *ngIf="timetableSelectionData !== null" (click)="timetableSelectionScreenToggle(true)" ><img src="../../../../assets/icons/list-numbered.png" alt="Show options" [tooltip]="'Show the options given by the processor'"></div>
        <div class="ttsettings__buttons--button" *ngIf="!studentViewMode" (click)="studentEditMode(0)"><img src="../../../../assets/icons/users.png" alt="Show filled timetable" [tooltip]="'Show the filled timetable with students'"></div>
        <div class="ttsettings__buttons--button" *ngIf="studentViewMode" (click)="studentEditMode(0)"><img src="../../../../assets/icons/cogs.png" alt="Show timetable setup" [tooltip]="'Show the timetable setup'"></div>
        <div class="ttsettings__buttons--button" (click)="run()"><img src="../../../../assets/icons/hammer.png" alt="Crunch the numbers and generate a timetable" [tooltip]="'Crunch the numbers and generate a timetable'"></div>
      </div>
    </div>

    <!-- <div class="ttsettings__buttons--row">
      <button class="input__button input__length--medium" (click)="print()">Print</button>
      <button class="input__button input__length--medium" (click)="googleExport()">GoogleIt</button>
      <button class="input__button input__length--medium" (click)="studentEditMode(0)">{{ studentViewMode ? 'Edit' : 'Student' }} Mode</button>
    </div>
    <div class="ttsettings__buttons--row">
      <button class="input__button input__length--medium" (click)="run()" [disabled]="loadedTimetable.students.length === 0 || loadedTimetable.schedule.blocks.length === 0">{{ !selectionData ? 'Process' : 'Reprocess' }}</button>
      <button class="input__button input__length--medium" (click)="timetableSelectionScreenToggle(true)" [disabled]="timetableSelectionData === null">Options</button>
    </div> -->
  </div>

  <div class="ttsettings__select" *ngIf="loadedTimetable && studentViewMode">
    <div class="ttsettings__text">Stats</div>

    <div *ngIf="loadedTimetable.schedule.scores"> <!-- take out nooneortwo when all consistent, i.e. trent doesnt have the wrong data! -->
      <div class="ttsettings__stats--bar">
        <div class="ttsettings__stats--bar--title ttsettings__stats--bar--title--long">Students</div>
        <div class="ttsettings__stats--bar--text">{{ loadedTimetable.students.length }} students</div>
      </div>
      <div class="ttsettings__stats--bar">
        <div class="ttsettings__stats--bar--title ttsettings__stats--bar--title--long">Missing 1st or 2nd</div>
        <div class="ttsettings__stats--bar--text">{{ loadedTimetable.schedule.scores.nonOneOrTwo.length }} students</div>
      </div>

      <div class="ttsettings__stats--bar ttsettings__stats--bar--list" *ngIf="loadedTimetable.schedule.scores.nonOneOrTwo.length > 0">
        <div class="ttsettings__stats--bar--student" *ngFor="let student of loadedTimetable.schedule.scores.nonOneOrTwo">
          <div class="ttsettings__stats--bar--student--name" (click)="studentEditMode(1, student)">{{ getStudentNamesFromArray([student]) }}</div>
          <div class="ttsettings__stats--bar--student--remove" (click)="removeFromNonOneOrTwo(student)">x</div>
        </div>
      </div>

      <div class="ttsettings__stats--bar" *ngIf="loadedTimetable.schedule.scores.notAllRequired">
        <div class="ttsettings__stats--bar--title ttsettings__stats--bar--title--long">Missing Required</div>
        <div class="ttsettings__stats--bar--text">{{ loadedTimetable.schedule.scores.notAllRequired.length }} students</div>
      </div>

      <div class="ttsettings__stats--bar ttsettings__stats--bar--list" *ngIf="loadedTimetable.schedule.scores.notAllRequired">
        <div class="ttsettings__stats--bar--student" *ngFor="let student of loadedTimetable.schedule.scores.notAllRequired">
          <div class="ttsettings__stats--bar--student--name" (click)="studentEditMode(1, student)">{{ getStudentNamesFromArray([student]) }}</div>
          <div class="ttsettings__stats--bar--student--remove" (click)="removeFromNotAllRequired(student)">x</div>
        </div>
      </div>

      <div class="ttsettings__stats--bar" *ngFor="let choice of loadedTimetable.schedule.scores.prioritySatisfied; let i = index">
        <div class="ttsettings__stats--bar--title">Priority {{ i + 1 }}</div>
        <div class="ttsettings__stats--bar--colour">
          <div [(colorPicker)]="loadedTimetable.colorPriority[i]" [cpOutputFormat]="'rgba'" [cpAlphaChannel]="'disabled'" [ngStyle]="{'background': loadedTimetable.colorPriority[i]}"></div>
        </div>
        <div class="ttsettings__stats--bar--bar" [ngStyle]="{'background-image': 'repeating-linear-gradient(to right, blue 0%, lightblue ' + (choice/loadedTimetable.students.length)*100 + '%, darkgray ' + (choice/loadedTimetable.students.length)*100 + '%, darkgray 100%)'}">
          <div class="ttsettings__stats--bar--percentage">{{ (choice/loadedTimetable.students.length)*100 | number:"1.2-2" }}%</div>
        </div>
      </div>
    </div>
  </div>

  <div class="ttsettings__select" *ngIf="loadedTimetable && !studentViewMode">
    <div class="ttsettings__text">
      <p>Courses</p>
      <div class="ttsettings__text--minmax" (click)="toggleSection('courses')">
        <img src="../../../../assets/icons/circle-up.png" alt="Collapse" *ngIf="showCourses">
        <img src="../../../../assets/icons/circle-down.png" alt="Collapse" *ngIf="!showCourses">
      </div>
    </div>

    <table class="ttsettings__courses" *ngIf="showCourses">
      <tr>
        <th>Name</th>
        <th [tooltip]="'Is this a required coure?'">Required</th>
        <th [tooltip]="'How many times the students is required to take this course'">Times</th>
        <th [tooltip]="'How many students can be placed in one block (can be overridden in the block view)'">Max Class Size</th>
        <th [tooltip]="'Delete this course'">Delete</th>
      </tr>
      <tr *ngFor="let course of loadedTimetable.courses">
        <td><input type="text" class="input__text input__length--medium" [(ngModel)]="course.name" placeholder="Name of Course" (blur)="editCourse(true)" (keyup)="editCourse(false, $event)"></td>
        <td><input type="checkbox" [(ngModel)]="course.requirement.required" (change)="changeRequired(course.id, $event)"></td>
        <td><input type="text" class="input__text input__length--short" [(ngModel)]="course.requirement.times"></td>
        <td><input type="text" class="input__text input__length--short" [(ngModel)]="course.classSize"></td>
        <td><button class="input__button input__length--veryshort" (click)="deleteCourse(course.id)">X</button></td>
      </tr>
    </table>

    <div class="ttsettings__courses--buttons" *ngIf="showCourses">
      <button class="input__button input__length--full" (click)="addCourse()">Add Course</button>
    </div>
  </div>

  <div class="ttsettings__select" *ngIf="loadedTimetable && !studentViewMode">
    <div class="ttsettings__text">
      <p>Data Collection</p>
      <div class="ttsettings__text--minmax" (click)="toggleSection('restrictions')">
        <img src="../../../../assets/icons/circle-up.png" alt="Collapse" *ngIf="showRestrictions">
        <img src="../../../../assets/icons/circle-down.png" alt="Collapse" *ngIf="!showRestrictions">
      </div>
    </div>

    <table class="ttsettings__courses" *ngIf="showRestrictions">
      <tr>
        <th>Name</th>
        <th>Description</th>
        <th>Poll</th>
        <th>Delete</th>
      </tr>
      <tbody *ngFor="let restriction of loadedTimetable.restrictions">
        <tr>
          <td><input type="text" class="input__text input__length--medium" [(ngModel)]="restriction.name" placeholder="Data Name" (blur)="editRestriction(true)" (keyup)="editRestriction(false, $event)"></td>
          <td><input type="text" class="input__text input__length--medium" [(ngModel)]="restriction.description"></td>
          <td><input type="checkbox" [(ngModel)]="restriction.poll"></td>
          <td><button class="input__button input__length--veryshort" (click)="deleteRestriction(restriction.id)">X</button></td>
        </tr>
        <tr>
          <td colspan="1">Add Option</td>
          <td colspan="1">
            <input type="text" class="input___text input__length--medium" id="restrictionOption{{restriction.id}}">
          </td>
          <td>
            <select>
              <option *ngFor="let option of restriction.options">{{ option.value }}</option>
            </select>
          </td>
          <td colspan="1">
            <button class="input__button input__length--veryshort" (click)="addOption(restriction.id)">1</button>
          </td>
        </tr>
      </tbody>
    </table>

    <div class="ttsettings__courses--buttons" *ngIf="showRestrictions">
      <button class="input__button input__length--full" (click)="addRestriction()">Add Data</button>
    </div>
  </div>

  <div class="ttsettings__flex" *ngIf="!studentViewMode">

    <div class="ttsettings__select" *ngIf="loadedTimetable">
      <div class="ttsettings__text">
        <p>Rooms</p>
        <div class="ttsettings__text--minmax" (click)="toggleSection('rooms')">
          <img src="../../../../assets/icons/circle-up.png" alt="Collapse" *ngIf="showRooms">
          <img src="../../../../assets/icons/circle-down.png" alt="Collapse" *ngIf="!showRooms">
        </div>
      </div>

      <table class="ttsettings__rooms" *ngIf="showRooms">
        <tr>
          <th>Room</th>
          <th>Delete</th>
        </tr>
        <tr *ngFor="let room of loadedTimetable.rooms">
          <td><input type="text" class="input__text input__length--medium" [(ngModel)]="room.name" placeholder="Name of Room"></td>
          <td><button class="input__button input__length--veryshort" (click)="deleteRoom(room.id)">X</button></td>
        </tr>
      </table>

      <div class="ttsettings__courses--buttons" *ngIf="showRooms">
        <button class="input__button input__length--full" (click)="addRoom()">Add Room</button>
      </div>
    </div>

    <div class="ttsettings__select" *ngIf="loadedTimetable">
      <div class="ttsettings__text">
        <p>Classes</p>
        <div class="ttsettings__text--minmax" (click)="toggleSection('classes')">
          <img src="../../../../assets/icons/circle-up.png" alt="Collapse" *ngIf="showClasses">
          <img src="../../../../assets/icons/circle-down.png" alt="Collapse" *ngIf="!showClasses">
        </div>
      </div>

      <table class="ttsettings__rooms" *ngIf="showClasses">
        <tr>
          <th>Class Teacher</th>
          <th>Delete</th>
        </tr>
        <tr *ngFor="let class of loadedTimetable.classes">
          <td><input type="text" class="input__text input__length--medium" [(ngModel)]="class.teacher" placeholder="Name of Teacher"></td>
          <td><button class="input__button input__length--veryshort" (click)="deleteClass(class.id)">X</button></td>
        </tr>
      </table>

      <div class="ttsettings__courses--buttons" *ngIf="showClasses">
        <button class="input__button input__length--full" (click)="addClass()">Add Class</button>
      </div>
    </div>

  </div>

</div>
